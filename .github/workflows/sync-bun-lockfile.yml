# Auto-sync bun lockfile when package-lock.json changes
name: Sync Bun Lockfile

on:
  pull_request:
    paths:
      - "package.json"
      - "package-lock.json"
  push:
    branches:
      - main
    paths:
      - "package.json"
      - "package-lock.json"

jobs:
  sync-bun-lockfile:
    name: Sync bun.lockb with package-lock.json
    runs-on: ubuntu-latest
    # Only run on PRs, not on main push (to avoid commit loops)
    if: github.event_name == 'pull_request'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: oven-sh/setup-bun@v2

      - name: Check if bun.lockb is out of sync
        id: check
        run: |
          # Install dependencies to regenerate bun.lockb
          bun install

          # Check if bun.lockb changed
          if git diff --exit-code bun.lockb > /dev/null; then
            echo "in_sync=true" >> $GITHUB_OUTPUT
            echo "âœ“ bun.lockb is in sync"
          else
            echo "in_sync=false" >> $GITHUB_OUTPUT
            echo "âœ— bun.lockb is out of sync"
          fi

      - name: Commit updated bun.lockb
        if: steps.check.outputs.in_sync == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bun.lockb
          git commit -m "chore: sync bun.lockb with package-lock.json" -m "Auto-generated by sync-bun-lockfile workflow"
          git push

      - name: Comment on PR
        if: steps.check.outputs.in_sync == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = 'ðŸ”„ **Bun lockfile synced**\n\nThe `bun.lockb` file has been automatically updated to match `package-lock.json`.\n\nThis happens when dependencies are added/updated with npm but CI uses bun.';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
