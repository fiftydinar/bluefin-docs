# Auto-Merge Configuration for Monthly Reports Workflow

## Executive Summary

**Recommended Approach:** Use `gh pr merge --auto` with enhanced workflow permissions

**Rationale:**
- Works with existing repository ruleset (merge queue + PR requirements)
- Requires minimal changes to current workflow
- Maintains security and quality gates
- No additional tokens or apps needed

**Implementation Effort:** Low (add 2-3 steps to workflow)

---

## Current State Analysis

### Repository Protection Configuration

**Ruleset:** `main` (active)
- **Merge Queue:** Enabled
  - Strategy: `ALLGREEN` (all status checks must pass)
  - Max entries to merge: 5
  - Min entries to merge: 1
  - Wait time: 5 minutes
  - Allowed merge methods: merge, squash, rebase
- **Pull Request Rules:**
  - Required approving review count: 0 (no reviews required)
  - Dismiss stale reviews on push: true
  - Require last push approval: true
  - Bypass actors: Organization admins only

**Auto-merge:** Enabled at repository level (`autoMergeAllowed: true`)

### Current Workflow Permissions

```yaml
permissions:
  contents: write     # For git commits
  pull-requests: read # For GraphQL queries
```

**Missing for auto-merge:**
- No PR creation permission
- No permission to enable auto-merge on PRs
- Workflow pushes directly to main (bypasses PR flow)

---

## Options Comparison

| Approach | Pros | Cons | Security | Implementation |
|----------|------|------|----------|----------------|
| **1. `gh pr merge --auto` with GITHUB_TOKEN** | ‚úÖ Native GitHub feature<br>‚úÖ Works with rulesets<br>‚úÖ No extra tokens needed<br>‚úÖ Respects status checks | ‚ùå Requires PR creation first<br>‚ùå Needs permission changes | üü¢ High - respects all rules | Easy - 10 lines |
| **2. GitHub App Token** | ‚úÖ Can bypass restrictions<br>‚úÖ Fine-grained permissions<br>‚úÖ Audit trail | ‚ùå Requires app setup<br>‚ùå Complex token generation<br>‚ùå Can bypass needed checks | üü° Medium - depends on config | Hard - 30+ lines |
| **3. Personal Access Token (PAT)** | ‚úÖ Simple to set up | ‚ùå Tied to user account<br>‚ùå Security risk<br>‚ùå Breaks on user removal | üî¥ Low - poor practice | Easy - 5 lines |
| **4. Direct push to main** | ‚úÖ Simplest | ‚ùå Bypasses all protection<br>‚ùå No review possible<br>‚ùå Violates governance | üî¥ Very Low - dangerous | Current state |

**Recommendation:** Option 1 (gh pr merge --auto)

---

## Implementation Details: Recommended Approach

### Changes Required

**1. Update Workflow Permissions**

```yaml
permissions:
  contents: write        # For git commits
  pull-requests: write   # To create and enable auto-merge on PRs
```

**2. Create PR Instead of Direct Push**

Replace the current "Commit and push report" step with:

```yaml
- name: Create feature branch
  run: |
    BRANCH_NAME="monthly-report/$(date +%Y-%m)"
    git checkout -b "$BRANCH_NAME"
    git config user.name "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"

- name: Commit changes to branch
  run: |
    git add reports/
    [ -f static/data/contributors-history.json ] && git add static/data/contributors-history.json || true
    git diff --staged --quiet || git commit -m "docs(reports): add monthly report for $(date +%B-%Y)"

- name: Push branch and create PR
  run: |
    BRANCH_NAME="monthly-report/$(date +%Y-%m)"
    git push -u origin "$BRANCH_NAME"
    gh pr create \
      --title "docs(reports): Monthly report for $(date +%B\ %Y)" \
      --body "$(cat <<'EOFBODY'
## Automated Monthly Report

This PR contains the automated monthly report generated on $(date +%Y-%m-%d).

### Contents
- Monthly activity summary
- Contributor statistics
- Project updates

### Automated Checks
- [ ] Build passes
- [ ] No lint errors
- [ ] Report renders correctly

**Note:** This PR was automatically generated by the monthly-reports workflow.
EOFBODY
)" \
      --base main \
      --head "$BRANCH_NAME"
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Enable auto-merge
  run: |
    BRANCH_NAME="monthly-report/$(date +%Y-%m)"
    gh pr merge --auto --merge "$BRANCH_NAME"
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**3. Add Status Check (Optional but Recommended)**

Ensure build passes before merge:

```yaml
- name: Wait for checks to pass
  run: |
    BRANCH_NAME="monthly-report/$(date +%Y-%m)"
    gh pr checks "$BRANCH_NAME" --watch --interval 30
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## How Auto-Merge Works

**Flow with Repository Ruleset:**

1. **PR Created** ‚Üí Workflow creates PR from feature branch
2. **Auto-merge Enabled** ‚Üí `gh pr merge --auto` sets auto-merge flag
3. **Merge Queue** ‚Üí PR enters queue (waits 5 min minimum per ruleset)
4. **Status Checks** ‚Üí All required checks must pass (ALLGREEN strategy)
5. **Merge** ‚Üí PR automatically merges when queue clears

**Merge Queue Behavior:**
- Groups PRs together (up to 5 at once)
- Tests them in merge queue branch
- Merges if all checks pass
- Prevents "merge race" conditions

**Required Conditions:**
- ‚úÖ No required reviews (already configured: `required_approving_review_count: 0`)
- ‚úÖ Auto-merge enabled (already configured: `autoMergeAllowed: true`)
- ‚úÖ Status checks pass (enforced by merge queue `ALLGREEN`)
- ‚úÖ No merge conflicts

---

## Security Considerations

### Quality Gates Maintained

‚úÖ **Build validation:** Merge queue tests PR before merging
‚úÖ **Status checks:** ALLGREEN strategy requires all checks pass
‚úÖ **Audit trail:** PR creates reviewable record
‚úÖ **Rollback capability:** PR can be reverted via GitHub UI

### What Auto-Merge Does NOT Bypass

üîí **Branch protection rules** - Still enforced
üîí **Required status checks** - Must pass
üîí **Merge queue** - PR must clear queue
üîí **Merge conflicts** - PR fails if conflicts exist

### What Changes vs Current Workflow

| Aspect | Current (Direct Push) | With Auto-Merge PR |
|--------|----------------------|-------------------|
| Protection bypassed? | ‚úÖ Yes (pushes to main) | ‚ùå No (uses PR) |
| Reviewable? | ‚ùå No audit trail | ‚úÖ Yes (PR history) |
| Can be blocked? | ‚ùå No way to stop | ‚úÖ Yes (close PR) |
| Status checks? | ‚ùå Skipped | ‚úÖ Required |

**Security Improvement:** Moving to PR-based flow is MORE secure than current direct push.

### Bot Security

**github-actions[bot]** is a special system account:
- Tied to GitHub Actions service (not a user)
- Cannot be compromised like PAT
- Permissions limited by workflow file
- Automatically revoked when workflow completes

---

## Alternative Approaches (Not Recommended)

### GitHub App Token

**When to use:** Need to bypass branch protection completely

**Setup:**
```yaml
- name: Generate GitHub App Token
  id: generate-token
  uses: actions/create-github-app-token@v1
  with:
    app-id: ${{ secrets.APP_ID }}
    private-key: ${{ secrets.APP_PRIVATE_KEY }}

- name: Enable auto-merge with app token
  run: gh pr merge --auto --merge "$PR_NUMBER"
  env:
    GH_TOKEN: ${{ steps.generate-token.outputs.token }}
```

**Why not recommended here:**
- Requires creating GitHub App
- More complex setup
- Overkill for this use case (no bypass needed)

### Personal Access Token

**When to use:** Never (bad practice)

**Why avoid:**
- Tied to user account (security risk)
- Breaks if user leaves
- Violates principle of least privilege
- GitHub discourages this pattern

---

## Testing Plan

**Before merging changes:**

1. **Test PR creation in feature branch:**
   ```bash
   git checkout -b test-monthly-reports-automerge
   # Make workflow changes
   git push -u origin test-monthly-reports-automerge
   gh workflow run monthly-reports.yml --ref test-monthly-reports-automerge
   ```

2. **Verify PR created:**
   ```bash
   gh pr list --author "github-actions[bot]"
   ```

3. **Check auto-merge enabled:**
   ```bash
   gh pr view <PR-NUMBER> --json autoMergeRequest
   ```

4. **Monitor merge queue:**
   ```bash
   gh api repos/projectbluefin/documentation/branches/main/protection --jq '.merge_queue'
   ```

5. **Verify merge completes:**
   - Watch for PR to auto-merge after status checks pass
   - Confirm report appears on deployed site

**Rollback Plan:**
If auto-merge fails, PR remains open and can be:
- Manually merged via GitHub UI
- Closed and workflow re-run
- Edited to fix issues before merge

---

## Minimal Implementation (Quick Start)

If you want the absolute minimum changes to enable auto-merge:

**File:** `.github/workflows/monthly-reports.yml`

```yaml
name: Generate Monthly Report

on:
  schedule:
    - cron: "0 10 1-7 * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write  # ‚Üê ADD THIS

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate monthly report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run generate-report

      - name: Create PR with auto-merge  # ‚Üê REPLACE "Commit and push" step
        run: |
          BRANCH="monthly-report/$(date +%Y-%m)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add reports/ static/data/contributors-history.json
          git commit -m "docs(reports): monthly report for $(date +%B-%Y)" || exit 0
          git push -u origin "$BRANCH"
          PR_URL=$(gh pr create --title "Monthly Report $(date +%B\ %Y)" --body "Automated monthly report" --base main --head "$BRANCH")
          gh pr merge --auto --merge "$PR_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**That's it!** This 3-line change enables auto-merge while respecting all protection rules.

---

## References

- **GitHub Docs - Auto-merge:** https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request
- **GitHub Docs - Merge Queue:** https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-a-merge-queue
- **GitHub Docs - GITHUB_TOKEN Permissions:** https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication
- **GitHub CLI - pr merge:** https://cli.github.com/manual/gh_pr_merge
- **Dependabot Auto-merge Example:** https://docs.github.com/en/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions#enabling-automerge-on-a-pull-request

---

## Next Steps

1. **Review this document** with team/maintainers
2. **Create test PR** with workflow changes on feature branch
3. **Trigger workflow manually** to verify PR creation + auto-merge
4. **Monitor first automated run** to ensure merge completes
5. **Document in AGENTS.md** for future workflow authors
